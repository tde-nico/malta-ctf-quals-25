from z3 import *

CONSTS = '423791A759DABEEF01020304691337AC'
CONSTS = bytes.fromhex(CONSTS)

enc = [
	0x39, 0xce, 0x69, 0x39, 0xa6, 0x61, 0x7c, 0xf4,
	0x0b, 0x3a, 0x21, 0x8d, 0x59, 0xf0, 0x15, 0x80,
	0x66, 0x41, 0x96, 0x75, 0xfb, 0x36, 0x67, 0x5c,
	0xa7, 0x95, 0x32, 0xee, 0xbc, 0xf7, 0xbf, 0xc2,
	0x95, 0x75, 0x60, 0x51, 0xb7, 0xaa, 0xa5, 0xd5,
	0xc5, 0x78, 0x29, 0x7a, 0xd3, 0xbf, 0xe0, 0x42,
	0x9e, 0x6f, 0xa0, 0x88, 0x84, 0x0c, 0x3f, 0x9e,
	0x7c, 0x09, 0x17, 0x8c, 0x5f, 0x96, 0x0e, 0xd7,
]
enc = [
	0x39, 0xce, 0x69, 0x39, 0xa6, 0x61, 0x7c, 0xf4,
	0x0b, 0x3a, 0x21, 0x8d, 0x59, 0xf0, 0x15, 0x80,
	0x66, 0x41, 0x96, 0x75, 0xfb, 0x36, 0x67, 0x5c,
	0xa7, 0x95, 0x32, 0xee, 0xbc, 0xf7, 0xbf, 0xc2,
	0x95, 0x75, 0x60, 0x51, 0xb7, 0xaa, 0xa5, 0xd5,
	0x82, 0x37, 0xeb, 0x47, 0x7d, 0x8e, 0x60, 0xc8,
	0x9e, 0x6f, 0xa0, 0x88, 0x84, 0x0c, 0x3f, 0x9e,
	0x7c, 0x09, 0x17, 0x8c, 0x5f, 0x96, 0x0e, 0xd7,
]


def ror(value, shift):
	if Z3:
		return RotateRight(value, shift)
	return ((value >> shift) | (value << (8 - shift))) & 0xFF

def rol(value, shift):
	return ((value << shift) | (value >> (8 - shift))) & 0xFF


def bit(r0, r1): # 0
	if Z3:
		return Extract(r1, r1, r0)
	return (r0 >> r1) & 1

def entrypoint(): # 10
	i = 0
	while i < 12:
		func_26(i)
		i += 1

def func_26(idx): # 26
	tmp = [None] * 16
	for i in range(16):
		curr = block[i]
		next = block[(i+1) % 16]

		if Z3:
			curr ^= rol(CONSTS[(i + idx) % 16], (i % 8))
			curr = ~((curr + (next ^ idx)) % 256)
			curr = Extract(7, 0, curr)
			curr = ror(curr, (i * 13) % 8)
		else:
			curr ^= rol(CONSTS[(i + idx) % 16], (i % 8))
			curr = ~((curr + (next ^ idx)) % 256) & 0xff
			curr = ror(curr, (i * 13) % 8)

		if Z3:
			curr = If(bit(next, 7) == 1, curr ^ 165, curr)
			curr = If(bit(next, 1) == 1, curr + 60, curr)
			curr = If(bit(next, 2) == 1, curr - 122, curr)
			curr = Extract(7, 0, curr)
		else:
			if bit(next, 7) == 1:
				curr ^= 165
			if bit(next, 1) == 1:
				curr = (curr + 60) % 256
			if bit(next, 2) == 1:
				curr = (curr - 122 + 256) & 255

		tmp[i] = curr

	for i in range(16):
		block[i] = tmp[(16 + 5*i - idx) % 16]

Z3 = 1
if Z3:
	s = Solver()
	b = [BitVec(f'b{i}', 8) for i in range(64)]
	original = b[:]
else:
	b = list(b'abcdefghijklmnopAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')
	b = list(b'maltactf{i_reallAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')
	b = list(b'maltactf{i_really_hope_the_relocXXXXXXXXXXXXXX_:P}\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')[:64]

BLOCKS = 4

for k in range(BLOCKS):
	block = b[k*16:(k+1)*16]
	entrypoint()
	if Z3:
		# enc = [
		# 	0x1a, 0xf1, 0x13, 0x34, 0x21, 0x85, 0x66, 0xbf, 0xfb, 0x66, 0x39, 0xd0, 0x39, 0x71, 0xa1, 0xda,
		# 	0x44, 0xac, 0x80, 0x33, 0x13, 0x8f, 0x6a, 0xfd, 0x85, 0x29, 0x1c, 0xee, 0xbd, 0x37, 0xc9, 0x6b,
		# 	0x44, 0xac, 0x80, 0x33, 0x13, 0x8f, 0x6a, 0xfd, 0x85, 0x29, 0x1c, 0xee, 0xbd, 0x37, 0xc9, 0x6b,
		# 	0x44, 0xac, 0x80, 0x33, 0x13, 0x8f, 0x6a, 0xfd, 0x85, 0x29, 0x1c, 0xee, 0xbd, 0x37, 0xc9, 0x6b
		# ]
		for i in range(16):
			s.add(block[i] == enc[16*k + i])
	else:
		print([hex(i) for i in block])

if Z3:
	if s.check() == sat:
		model = s.model()
		result = [model[original[i]].as_long() for i in range(16 * BLOCKS)]
		print(''.join([chr(i) for i in result]))
	else:
		print("No solution found")
